<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airspace Copilot - Real AI System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
        }
        .tab-button {
            transition: all 0.3s;
        }
        .tab-content {
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-bubble {
            max-width: 80%;
        }
        .user-bubble {
            background-color: #2563eb;
            color: white;
            border-radius: 1rem 1rem 0.25rem 1rem;
        }
        .agent-bubble {
            background-color: #1f2937;
            color: #d1d5db;
            border-radius: 1rem 1rem 1rem 0.25rem;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-4xl mx-auto bg-[#161b22] rounded-xl shadow-2xl p-6 md:p-8">
        <header class="mb-6 text-center">
            <h1 class="text-3xl md:text-4xl font-extrabold text-[#5eead4] mb-2">‚úàÔ∏è Airspace Copilot</h1>
            <p class="text-sm text-gray-400">Multi-Agent AI System powered by Groq LLM & MCP</p>
        </header>

        <div id="status-banner" class="bg-blue-900 border border-blue-700 text-blue-300 p-3 rounded-lg mb-6 text-sm">
            <span class="font-bold">üîå Status:</span> <span id="connection-status">Checking backend connection...</span>
        </div>

        <!-- Tab Controls -->
        <div class="flex border-b border-gray-700 mb-6">
            <button id="tab-ops" class="tab-button py-2 px-4 text-sm font-medium text-gray-300 hover:text-white border-b-2 border-transparent transition duration-300" onclick="showTab('ops')">
                <i data-lucide="monitor" class="inline-block w-4 h-4 mr-2"></i> Operations View
            </button>
            <button id="tab-traveler" class="tab-button py-2 px-4 text-sm font-medium text-gray-300 hover:text-white border-b-2 border-transparent transition duration-300" onclick="showTab('traveler')">
                <i data-lucide="plane" class="inline-block w-4 h-4 mr-2"></i> Traveler View
            </button>
        </div>

        <!-- Content Area -->
        <div id="content-area">
            <!-- Operations View -->
            <div id="ops-content" class="tab-content hidden">
                <div class="mb-6 p-4 bg-[#1f2937] rounded-lg">
                    <h2 class="text-xl font-semibold text-white mb-3 flex items-center">
                        <i data-lucide="cloud" class="w-5 h-5 mr-2 text-indigo-400"></i> Airspace Ops Copilot
                    </h2>
                    <label for="ops-region" class="block text-sm font-medium text-gray-400 mb-2">Select Region</label>
                    <select id="ops-region" class="w-full p-2 bg-[#2d3748] border border-gray-600 rounded-lg text-white focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="region1">Region 1</option>
                        <option value="region2">Region 2</option>
                        <option value="region3">Region 3</option>
                    </select>
                    <button onclick="analyzeAirspace()" class="mt-4 w-full py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition duration-300 flex items-center justify-center" id="ops-analyze-btn">
                        <i data-lucide="activity" class="w-5 h-5 mr-2"></i> Analyze Airspace
                    </button>
                </div>

                <!-- AI Agent Summary -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-white mb-2 flex items-center">
                        <i data-lucide="bot" class="w-4 h-4 mr-2 text-green-400"></i> AI Agent Analysis
                    </h3>
                    <div id="ops-summary" class="p-4 bg-[#1f2937] rounded-lg text-gray-300 min-h-[100px] border border-gray-700">
                        Click "Analyze Airspace" to start AI analysis...
                    </div>
                </div>

                <!-- Flight Statistics -->
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="bg-[#1f2937] p-4 rounded-lg border border-gray-700">
                        <div class="text-gray-400 text-sm">Total Flights</div>
                        <div id="stat-total" class="text-2xl font-bold text-white">-</div>
                    </div>
                    <div class="bg-[#1f2937] p-4 rounded-lg border border-gray-700">
                        <div class="text-gray-400 text-sm">Normal</div>
                        <div id="stat-normal" class="text-2xl font-bold text-green-400">-</div>
                    </div>
                    <div class="bg-[#1f2937] p-4 rounded-lg border border-gray-700">
                        <div class="text-gray-400 text-sm">Anomalous</div>
                        <div id="stat-anomalous" class="text-2xl font-bold text-red-400">-</div>
                    </div>
                </div>

                <!-- Flight Table -->
                <h3 class="text-lg font-semibold text-white mb-2 flex items-center">
                    <i data-lucide="list" class="w-4 h-4 mr-2 text-red-400"></i> Active Flights
                </h3>
                <div class="overflow-x-auto rounded-lg border border-gray-700">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-[#1f2937]">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-400 uppercase">Callsign</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-400 uppercase">ICAO24</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-400 uppercase">Altitude (m)</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-400 uppercase">Speed (m/s)</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-400 uppercase">Status</th>
                            </tr>
                        </thead>
                        <tbody id="ops-flight-table" class="bg-[#161b22] divide-y divide-gray-800 text-sm">
                            <tr><td colspan="5" class="text-center py-4 text-gray-500">No data yet</td></tr>
                        </tbody>
                    </table>
                </div>

            </div>

            <!-- Traveler View -->
            <div id="traveler-content" class="tab-content hidden">
                <div class="p-4 bg-[#1f2937] rounded-lg mb-6">
                    <h2 class="text-xl font-semibold text-white mb-3 flex items-center">
                        <i data-lucide="message-square" class="w-5 h-5 mr-2 text-teal-400"></i> Personal Flight Watchdog
                    </h2>
                    <label for="traveler-flight-id" class="block text-sm font-medium text-gray-400 mb-2">Enter Flight Callsign or ICAO24</label>
                    <input type="text" id="traveler-flight-id" placeholder="e.g., THY4KZ or 4baa1a" class="w-full p-2 bg-[#2d3748] border border-gray-600 rounded-lg text-white focus:ring-teal-500 focus:border-teal-500 mb-3">
                    <button onclick="startFlightWatch()" class="w-full py-2 bg-teal-600 hover:bg-teal-700 text-white font-bold rounded-lg transition duration-300 flex items-center justify-center" id="traveler-watch-btn">
                        <i data-lucide="search" class="w-5 h-5 mr-2"></i> Track Flight
                    </button>
                    <p id="flight-status" class="mt-2 text-sm text-gray-400"></p>
                </div>

                <!-- Flight Info Panel -->
                <div id="flight-info-panel" class="hidden mb-6 p-4 bg-[#1f2937] rounded-lg border border-gray-700">
                    <h3 class="text-lg font-semibold text-white mb-3">Flight Information</h3>
                    <div id="flight-info-content" class="text-gray-300"></div>
                </div>

                <!-- Chat Area -->
                <div class="flex flex-col h-[400px] bg-[#161b22] rounded-lg border border-gray-700">
                    <div id="chat-messages" class="flex-grow overflow-y-auto p-4 space-y-4">
                        <div class="flex justify-start">
                            <div class="agent-bubble p-3">
                                üëã Hello! I'm your AI Flight Watchdog powered by Groq. Enter your flight ID above and click "Track Flight" to get started!
                            </div>
                        </div>
                    </div>
                    <div class="p-4 border-t border-gray-700 flex">
                        <input type="text" id="chat-input" placeholder="Ask about your flight..." class="flex-grow p-3 bg-[#2d3748] border border-gray-600 rounded-l-lg text-white disabled:opacity-50" disabled>
                        <button onclick="sendChatMessage()" id="chat-send-btn" class="bg-teal-600 hover:bg-teal-700 text-white p-3 rounded-r-lg disabled:opacity-50 transition duration-300" disabled>
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Loading Overlay -->
        <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center">
            <div class="bg-[#1f2937] p-8 rounded-xl shadow-lg flex flex-col items-center">
                <svg class="animate-spin h-8 w-8 text-[#5eead4]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-white text-lg" id="loading-message">AI Agent is analyzing...</p>
            </div>
        </div>

    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5000/api';
        let currentFlight = null;

        // ============================================
        // Utility Functions
        // ============================================

        function showLoading(message = 'AI Agent is analyzing...') {
            document.getElementById('loading-message').textContent = message;
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function showError(message) {
            alert('Error: ' + message);
        }

        // ============================================
        // Backend Connection Check
        // ============================================

        async function checkBackendConnection() {
            const statusEl = document.getElementById('connection-status');
            const bannerEl = document.getElementById('status-banner');
            
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                const data = await response.json();
                
                if (data.status === 'ok') {
                    statusEl.textContent = '‚úÖ Connected to AI Backend';
                    bannerEl.classList.remove('bg-blue-900', 'border-blue-700', 'text-blue-300');
                    bannerEl.classList.add('bg-green-900', 'border-green-700', 'text-green-300');
                } else {
                    throw new Error('Backend not healthy');
                }
            } catch (error) {
                statusEl.textContent = '‚ùå Backend Offline - Please start backend.py';
                bannerEl.classList.remove('bg-blue-900', 'border-blue-700', 'text-blue-300');
                bannerEl.classList.add('bg-red-900', 'border-red-700', 'text-red-300');
            }
        }

        // ============================================
        // Operations Mode
        // ============================================

        async function analyzeAirspace() {
            const region = document.getElementById('ops-region').value;
            const opsSummaryEl = document.getElementById('ops-summary');
            const flightTableEl = document.getElementById('ops-flight-table');
            const analyzeBtn = document.getElementById('ops-analyze-btn');
            
            showLoading('AI Ops Agent is analyzing airspace...');
            analyzeBtn.disabled = true;
            opsSummaryEl.innerHTML = '<span class="text-[#5eead4]">Fetching data from MCP server...</span>';
            flightTableEl.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Processing...</td></tr>';

            try {
                const response = await fetch(`${API_BASE_URL}/ops/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ region: region })
                });

                if (!response.ok) {
                    throw new Error(`Backend error: ${response.status}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Analysis failed');
                }

                // Update statistics
                document.getElementById('stat-total').textContent = result.total_flights;
                document.getElementById('stat-normal').textContent = result.total_flights - result.anomalous_flights;
                document.getElementById('stat-anomalous').textContent = result.anomalous_flights;

                // Update AI summary (convert newlines to <br>)
                opsSummaryEl.innerHTML = result.analysis.replace(/\n/g, '<br>');

                // Update flight table
                let tableHtml = '';
                result.flights.forEach(flight => {
                    const anomaly = flight.anomaly_label || 'Normal';
                    const statusColor = anomaly === 'Normal' ? 'text-green-400' : 'text-red-400 font-bold';
                    
                    tableHtml += `
                        <tr class="hover:bg-[#1f2937]">
                            <td class="px-3 py-2 text-gray-200">${flight.callsign || 'N/A'}</td>
                            <td class="px-3 py-2 text-gray-200">${flight.icao24 || 'N/A'}</td>
                            <td class="px-3 py-2 text-gray-200">${flight.geo_altitude || flight.baro_altitude || 'N/A'}</td>
                            <td class="px-3 py-2 text-gray-200">${flight.velocity || 'N/A'}</td>
                            <td class="px-3 py-2 ${statusColor}">${anomaly}</td>
                        </tr>
                    `;
                });
                
                flightTableEl.innerHTML = tableHtml || '<tr><td colspan="5" class="text-center py-4 text-gray-500">No flights found</td></tr>';

            } catch (error) {
                console.error("Ops Analysis Failed:", error);
                opsSummaryEl.innerHTML = `<span class="text-red-500">‚ùå Error: ${error.message}</span>`;
                flightTableEl.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Failed to load data</td></tr>';
                showError(error.message);
            } finally {
                hideLoading();
                analyzeBtn.disabled = false;
                lucide.createIcons();
            }
        }

        // ============================================
        // Traveler Mode
        // ============================================

        async function startFlightWatch() {
            const flightIdInput = document.getElementById('traveler-flight-id');
            const flightId = flightIdInput.value.trim();
            const flightStatusEl = document.getElementById('flight-status');
            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');
            const chatMessagesEl = document.getElementById('chat-messages');
            const flightInfoPanel = document.getElementById('flight-info-panel');
            const flightInfoContent = document.getElementById('flight-info-content');

            if (!flightId) {
                showError('Please enter a flight ID');
                return;
            }

            showLoading('AI Traveler Agent is tracking your flight...');
            
            try {
                const response = await fetch(`${API_BASE_URL}/traveler/track`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ flight_id: flightId })
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Flight not found');
                }

                // Store current flight
                currentFlight = flightId;

                // Update status
                flightStatusEl.textContent = `‚úÖ Tracking: ${flightId}`;
                flightStatusEl.classList.remove('text-red-500');
                flightStatusEl.classList.add('text-green-500');

                // Show flight info panel with AI summary
                flightInfoPanel.classList.remove('hidden');
                flightInfoContent.innerHTML = `
                    <div class="mb-2"><strong>AI Summary:</strong></div>
                    <div class="text-sm mb-3">${result.summary}</div>
                    <div class="text-sm ${result.issues.includes('‚úì') ? 'text-green-400' : 'text-yellow-400'}">
                        ${result.issues}
                    </div>
                `;

                // Enable chat
                chatInput.disabled = false;
                chatSendBtn.disabled = false;

                // Clear and add greeting
                chatMessagesEl.innerHTML = '';
                addChatMessage('agent', `‚úàÔ∏è I've located flight ${flightId}! ${result.summary.substring(0, 150)}... How can I help you?`);

            } catch (error) {
                console.error("Flight tracking failed:", error);
                flightStatusEl.textContent = `‚ùå ${error.message}`;
                flightStatusEl.classList.remove('text-green-500');
                flightStatusEl.classList.add('text-red-500');
                
                chatInput.disabled = true;
                chatSendBtn.disabled = true;
                flightInfoPanel.classList.add('hidden');
                
                showError(error.message);
            } finally {
                hideLoading();
                lucide.createIcons();
            }
        }

        function addChatMessage(role, message) {
            const chatMessagesEl = document.getElementById('chat-messages');
            const bubbleClass = role === 'user' ? 'justify-end' : 'justify-start';
            const messageClass = role === 'user' ? 'user-bubble' : 'agent-bubble';

            const messageHtml = `
                <div class="flex ${bubbleClass}">
                    <div class="chat-bubble p-3 ${messageClass}">
                        ${message.replace(/\n/g, '<br>')}
                    </div>
                </div>
            `;
            chatMessagesEl.innerHTML += messageHtml;
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        }

        async function sendChatMessage() {
            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');
            const userQuestion = chatInput.value.trim();

            if (!userQuestion || !currentFlight) return;

            addChatMessage('user', userQuestion);
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatInput.disabled = true;

            showLoading('AI Agent is thinking...');

            try {
                const response = await fetch(`${API_BASE_URL}/traveler/ask`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        flight_id: currentFlight,
                        question: userQuestion 
                    })
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to get answer');
                }

                addChatMessage('agent', result.answer);

            } catch (error) {
                console.error("Question failed:", error);
                addChatMessage('agent', `‚ùå Sorry, I encountered an error: ${error.message}`);
            } finally {
                hideLoading();
                chatSendBtn.disabled = false;
                chatInput.disabled = false;
                chatInput.focus();
            }
        }

        document.getElementById('chat-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !this.disabled) {
                sendChatMessage();
            }
        });

        // ============================================
        // Tab Management
        // ============================================

        function showTab(tabName) {
            const tabs = ['ops', 'traveler'];
            tabs.forEach(tab => {
                const content = document.getElementById(`${tab}-content`);
                const button = document.getElementById(`tab-${tab}`);
                if (tab === tabName) {
                    content.classList.remove('hidden');
                    button.classList.add('border-indigo-500', 'text-white');
                    button.classList.remove('border-transparent', 'text-gray-300');
                } else {
                    content.classList.add('hidden');
                    button.classList.remove('border-indigo-500', 'text-white');
                    button.classList.add('border-transparent', 'text-gray-300');
                }
            });
            lucide.createIcons();
        }

        // ============================================
        // Initialization
        // ============================================

        document.addEventListener('DOMContentLoaded', () => {
            showTab('ops');
            checkBackendConnection();
            lucide.createIcons();
            
            // Recheck connection every 10 seconds
            setInterval(checkBackendConnection, 10000);
        });

    </script>
</body>
</html>